# Production Deployment (Azure + Managed Identity)

This guide outlines production deployment using GitHub Actions with Azure authentication and secretless SQL access via Azure Managed Identity (MSI).

## What you get
- Azure App Service (Linux, HTTPS only)
- Azure SQL (Serverless)
- GitHub OAuth for users
- GitHub App for backend services
- Hangfire dashboard at `/hangfire`
- Test Mode disabled in production
- Secretless SQL via MSI

## Current Implementation

The production deployment workflow (`.github/workflows/ci-cd-prod.yml`) runs automatically on pushes to `main` and can be manually triggered via `workflow_dispatch`.

### Workflow Structure

```
build
 └── deploy
```

### Build Job

- **Purpose**: Compile and package the application
- **Steps**:
  - Checks out code
  - Sets up .NET 8.x SDK
  - Builds the solution in Release configuration
  - Publishes the application to `./publish`
  - Uploads artifact for deployment

### Deploy Job

- **Purpose**: Deploy the application to Azure App Service
- **Depends on**: `build`
- **Permissions**: 
  - `id-token: write` (for OIDC authentication)
  - `contents: read`
- **Steps**:
  1. Downloads build artifact
  2. Authenticates to Azure using OIDC
  3. Deploys to Azure Web App (`wa-10xghpolicies-prod`)
  4. Applies app settings (idempotent)

### Required Secrets

The workflow requires the following GitHub Repository Secrets:

#### Azure Authentication
- `AZUREAPPSERVICE_CLIENTID_*` - Azure AD App Registration Client ID
- `AZUREAPPSERVICE_TENANTID_*` - Azure AD Tenant ID  
- `AZUREAPPSERVICE_SUBSCRIPTIONID_*` - Azure Subscription ID

**Note**: These secrets use the format generated by Azure Portal when deploying via "Deploy to Web App" action. The suffix is a hash for uniqueness.

#### Application Configuration
- `GH_APP_ID` - GitHub App ID (for backend services)
- `GH_APP_PRIVATE_KEY` - GitHub App private key (full PEM content)
- `GH_APP_INSTALLATION_ID` - GitHub App Installation ID
- `ORG_NAME` - GitHub organization name
- `OAUTH_CLIENT_ID` - GitHub OAuth App Client ID (for user login)
- `OAUTH_CLIENT_SECRET` - GitHub OAuth App Client Secret

### App Settings Applied

The deployment workflow sets the following app settings on Azure App Service:

- `ASPNETCORE_ENVIRONMENT=Production`
- `TestMode__Enabled=false`
- `GitHubApp__AppId` - GitHub App ID
- `GitHubApp__PrivateKey` - GitHub App private key
- `GitHubApp__InstallationId` - Installation ID
- `GitHubApp__OrganizationName` - Organization name
- `GitHub__ClientId` - OAuth Client ID
- `GitHub__ClientSecret` - OAuth Client Secret
- `ConnectionStrings__DefaultConnection` - MSI-based SQL connection string

### SQL Connection String

The application uses Azure Managed Identity (MSI) for secretless database access:

```
Server=tcp:sql-10xghpolicies.database.windows.net,1433;Database=sqldb-10xghpolicies;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;Authentication=Active Directory Managed Identity
```

This eliminates the need for SQL username/password credentials in app settings.
