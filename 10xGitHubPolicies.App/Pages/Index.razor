@page "/"
@using _10xGitHubPolicies.App.Services.Dashboard
@using _10xGitHubPolicies.App.Services.Scanning
@using _10xGitHubPolicies.App.ViewModels
@using Hangfire
@inject IDashboardService DashboardService
@inject IScanningService ScanningService
@inject IBackgroundJobClient BackgroundJobClient

<PageTitle>Compliance Dashboard</PageTitle>

<MudGrid Justify="Justify.FlexStart" Spacing="3">
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4" Style="height: 100%;">
            <MudText Typo="Typo.h6">Overall Compliance</MudText>
            <MudText Typo="Typo.h3">@($"{_viewModel?.CompliancePercentage:F2}%")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4" Style="height: 100%;">
            <MudText Typo="Typo.h6">Total Repositories</MudText>
            <MudText Typo="Typo.h3">@_viewModel?.TotalRepositories</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4" Style="height: 100%; background-color: var(--mud-palette-success); color: var(--mud-palette-success-text);">
            <MudText Typo="Typo.h6">Compliant</MudText>
            <MudText Typo="Typo.h3">@_viewModel?.CompliantRepositories</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Elevation="2" Class="pa-4" Style="height: 100%; background-color: var(--mud-palette-error); color: var(--mud-palette-error-text);">
            <MudText Typo="Typo.h6">Non-Compliant</MudText>
            <MudText Typo="Typo.h3">@_viewModel?.NonCompliantRepositoriesCount</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudPaper Elevation="2" Class="mt-4">
    <MudTable Items="@_viewModel?.NonCompliantRepositories" Dense="true" Hover="true" Filter="new Func<NonCompliantRepositoryViewModel, bool>(FilterFunc)">
        <ToolBarContent>
            <MudTextField @bind-Value="_nameFilter" Placeholder="Filter by name..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
            <MudSpacer />
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Refresh" 
                       OnClick="StartScan"
                       Disabled="_isScanning">
                @if (_isScanning)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Scanning...</MudText>
                }
                else
                {
                    <MudText>Scan Now</MudText>
                }
            </MudButton>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Repository</MudTh>
            <MudTh>Violations</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Repository">
                <MudLink Href="@context.Url" Target="_blank">@context.Name</MudLink>
            </MudTd>
            <MudTd DataLabel="Violations">
                @foreach (var policy in context.ViolatedPolicies)
                {
                    <MudChip T="string" Text="@policy" Color="Color.Error" Size="Size.Small" />
                }
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
</MudPaper>

@code {
    private DashboardViewModel? _viewModel;
    private string _nameFilter = string.Empty;
    private bool _isScanning = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private bool FilterFunc(NonCompliantRepositoryViewModel repo)
    {
        if (string.IsNullOrWhiteSpace(_nameFilter))
            return true;
        if (repo.Name.Contains(_nameFilter, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }

    private async Task LoadDashboardData()
    {
        _viewModel = await DashboardService.GetDashboardViewModelAsync(_nameFilter);
    }

    private async Task StartScan()
    {
        _isScanning = true;
        StateHasChanged();

        BackgroundJobClient.Enqueue<IScanningService>(s => s.PerformScanAsync());
        
        // A simple delay to allow the background job to start and finish.
        // In a real-world scenario, you'd use SignalR or a polling mechanism to get completion status.
        await Task.Delay(5000); 

        await LoadDashboardData();
        _isScanning = false;
        StateHasChanged();
    }
}