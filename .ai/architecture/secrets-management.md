# Secret Management Specification

## 1. Introduction

The secure management of application secrets is critical for the 10x GitHub Policy Enforcer. This document outlines the strategy for handling sensitive credentials, such as API keys and private keys, for both local development and production environments. The primary goal is to prevent secrets from being committed to the source control repository.

---

## 2. Local Development

For local development, secrets will be stored outside the project folder using the **.NET Secret Manager**. This prevents credentials from being accidentally committed to source control.

### 2.1. Usage

1.  **Initialize Secret Storage:** Navigate to the project directory and run the initialization command.
    ```shell
    cd 10xGitHubPolicies.App
    dotnet user-secrets init
    ```
2.  **Set Secrets:** Use the `dotnet user-secrets set` command to store each required secret.

### 2.2. Required Secrets

The following secrets must be configured for the application to run locally.

#### OAuth App (For User Login)
```shell
dotnet user-secrets set "GitHub:ClientId" "YOUR_OAUTH_APP_CLIENT_ID"
dotnet user-secrets set "GitHub:ClientSecret" "YOUR_OAUTH_APP_CLIENT_SECRET"
```

#### GitHub App (For Backend Services)
```shell
dotnet user-secrets set "GitHubApp:AppId" "YOUR_GITHUB_APP_ID"
dotnet user-secrets set "GitHubApp:PrivateKey" "YOUR_GITHUB_APP_PRIVATE_KEY_CONTENT"
dotnet user-secrets set "GitHubApp:InstallationId" "YOUR_GITHUB_APP_INSTALLATION_ID"
```
**Note on `PrivateKey`**: The value for `GitHubApp:PrivateKey` should be the full content of the `.pem` file generated by GitHub. It must include the `-----BEGIN RSA PRIVATE KEY-----` and `-----END RSA PRIVATE KEY-----` markers. When setting this via the command line, you may need to format it as a single line with `\n` replacing the newlines, or manage it through the `secrets.json` file directly for easier formatting.

---

## 3. Production Deployment (Azure App Service)

For the production environment hosted on Azure App Service, we use **GitHub Secrets** stored in the repository and applied to Azure App Service via the CI/CD pipeline. This approach leverages GitHub's secure secret storage and applies secrets as app settings during deployment.

### 3.1. Architecture

1.  Secrets are stored in **GitHub Repository Secrets** (Settings → Secrets → Actions).
2.  The CI/CD workflow (`.github/workflows/ci-cd-prod.yml`) retrieves secrets during deployment.
3.  Secrets are applied as **App Settings** to Azure App Service using the `az webapp config appsettings set` command.
4.  The Azure App Service uses these app settings at runtime via the standard ASP.NET Core configuration system.
5.  **SQL Database Access**: Uses Azure Managed Identity (MSI) for secretless database access - no SQL credentials are stored in app settings.

### 3.2. Deployment Workflow

1.  **Store Secrets in GitHub:**
    *   Navigate to your GitHub repository → Settings → Secrets → Actions
    *   Add the following secrets:
        *   `GH_APP_ID` - GitHub App ID (for backend services)
        *   `GH_APP_PRIVATE_KEY` - GitHub App private key (full PEM content)
        *   `GH_APP_INSTALLATION_ID` - GitHub App Installation ID
        *   `ORG_NAME` - GitHub organization name
        *   `OAUTH_CLIENT_ID` - GitHub OAuth App Client ID (for user login)
        *   `OAUTH_CLIENT_SECRET` - GitHub OAuth App Client Secret
        *   `AZUREAPPSERVICE_CLIENTID_*` - Azure AD App Registration Client ID
        *   `AZUREAPPSERVICE_TENANTID_*` - Azure AD Tenant ID
        *   `AZUREAPPSERVICE_SUBSCRIPTIONID_*` - Azure Subscription ID

2.  **CI/CD Pipeline:**
    *   The production deployment workflow automatically applies secrets as app settings during deployment.
    *   Secrets are referenced in the workflow using `${{ secrets.SECRET_NAME }}` syntax.
    *   The `az webapp config appsettings set` command applies all app settings idempotently.

3.  **Azure Managed Identity for SQL:**
    *   The Azure App Service is assigned a **System-Assigned Managed Identity**.
    *   This identity is granted access to the SQL Database (no username/password required).
    *   The connection string uses `Authentication=Active Directory Managed Identity` parameter.

### 3.3. Security Benefits

- **No Secrets in Code**: Secrets are never committed to source control.
- **GitHub Secrets Encryption**: GitHub encrypts secrets at rest and in transit.
- **Least Privilege**: Secrets are only accessible to authorized GitHub Actions workflows.
- **Secretless SQL**: Database access uses Managed Identity, eliminating SQL credentials.
- **Audit Trail**: GitHub Actions provides an audit trail of secret usage.
