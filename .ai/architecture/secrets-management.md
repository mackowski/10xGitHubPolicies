# Secret Management Specification

## 1. Introduction

The secure management of application secrets is critical for the 10x GitHub Policy Enforcer. This document outlines the strategy for handling sensitive credentials, such as API keys and private keys, for both local development and production environments. The primary goal is to prevent secrets from being committed to the source control repository.

---

## 2. Local Development

For local development, secrets will be stored outside the project folder using the **.NET Secret Manager**. This prevents credentials from being accidentally committed to source control.

### 2.1. Usage

1.  **Initialize Secret Storage:** Navigate to the project directory and run the initialization command.
    ```shell
    cd 10xGitHubPolicies.App
    dotnet user-secrets init
    ```
2.  **Set Secrets:** Use the `dotnet user-secrets set` command to store each required secret.

### 2.2. Required Secrets

The following secrets must be configured for the application to run locally.

#### OAuth App (For User Login)
```shell
dotnet user-secrets set "GitHub:ClientId" "YOUR_OAUTH_APP_CLIENT_ID"
dotnet user-secrets set "GitHub:ClientSecret" "YOUR_OAUTH_APP_CLIENT_SECRET"
```

#### GitHub App (For Backend Services)
```shell
dotnet user-secrets set "GitHubApp:AppId" "YOUR_GITHUB_APP_ID"
dotnet user-secrets set "GitHubApp:PrivateKey" "YOUR_GITHUB_APP_PRIVATE_KEY_CONTENT"
dotnet user-secrets set "GitHubApp:InstallationId" "YOUR_GITHUB_APP_INSTALLATION_ID"
```
**Note on `PrivateKey`**: The value for `GitHubApp:PrivateKey` should be the full content of the `.pem` file generated by GitHub. It must include the `-----BEGIN RSA PRIVATE KEY-----` and `-----END RSA PRIVATE KEY-----` markers. When setting this via the command line, you may need to format it as a single line with `\n` replacing the newlines, or manage it through the `secrets.json` file directly for easier formatting.

---

## 3. Production Deployment (Azure App Service)

For the production environment hosted on Azure App Service, we will use **Azure Key Vault** integrated with the App Service's **Managed Identity**. This is the most secure method as it eliminates the need for any secrets to be stored in the application's configuration files or as environment variables in the App Service.

### 3.1. Architecture

1.  The Azure App Service is assigned a **System-Assigned Managed Identity**, which is an identity in Azure Active Directory that is managed by Azure.
2.  This identity is granted specific, limited permissions (get, list) to access secrets within an Azure Key Vault instance.
3.  The application code uses the `Azure.Identity` library to authenticate with the Key Vault using this managed identity. No connection string or secret is required for the application to connect to the Key Vault.
4.  The application securely fetches the secrets from Key Vault at startup and uses them for its configuration.

### 3.2. Deployment Workflow

1.  **Create Azure Key Vault:** Provision a new Azure Key Vault instance in your Azure subscription.
2.  **Store Secrets in Key Vault:** Add the application secrets to the Key Vault. The secret names should use a double-underscore `__` to represent the colon `:` used in the `appsettings.json` configuration structure.
    *   `GitHub--ClientId`
    *   `GitHub--ClientSecret`
    *   `GitHubApp--AppId`
    *   `GitHubApp--PrivateKey`
    *   `GitHubApp--InstallationId`
3.  **Enable Managed Identity:** In the Azure portal, navigate to your Azure App Service. Under "Settings," select "Identity" and turn the status of the "System assigned" identity to **On**.
4.  **Grant Permissions to Key Vault:**
    *   Navigate to your Azure Key Vault instance.
    *   Go to "Access policies" and click "Create".
    *   Under "Secret permissions," grant the `Get` and `List` permissions.
    *   In the "Principal" selection, search for and select the name of your App Service's managed identity.
    *   Create the access policy.
5.  **Configure Application for Key Vault:**
    *   Add the `Azure.Identity` and `Microsoft.Extensions.Configuration.AzureKeyVault` NuGet packages to the `10xGitHubPolicies.App` project.
    *   In `Program.cs`, modify the host builder to connect to Azure Key Vault.

    ```csharp
    // Example for Program.cs
    public static IHostBuilder CreateHostBuilder(string[] args) =>
        Host.CreateDefaultBuilder(args)
            .ConfigureAppConfiguration((context, config) =>
            {
                if (context.HostingEnvironment.IsProduction())
                {
                    var builtConfig = config.Build();
                    var keyVaultEndpoint = builtConfig["AzureKeyVaultEndpoint"];
    
                    if (!string.IsNullOrEmpty(keyVaultEndpoint))
                    {
                        var credential = new DefaultAzureCredential();
                        config.AddAzureKeyVault(new Uri(keyVaultEndpoint), credential);
                    }
                }
            })
            .ConfigureWebHostDefaults(webBuilder =>
            {
                webBuilder.UseStartup<Startup>();
            });
    ```
    *   Add an `AzureKeyVaultEndpoint` setting to your `appsettings.Production.json` or as an Application Setting in the Azure App Service configuration. This should contain the URI of your Key Vault (e.g., `https://my-vault-name.vault.azure.net/`).
